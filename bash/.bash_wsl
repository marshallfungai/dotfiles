#!/usr/bin/env bash

# WSL2 Environment Setup
# This file should be sourced from .bashrc
# Use windows agent

## In PowerShell:
#Start-Service ssh-agent || -Startup-Type Automatic
#ssh-add $env:USERPROFILE\.ssh\id_key

if grep -qi microsoft /proc/version; then

    # Add OpenSSH to PATH if not already there
    export PATH="$PATH:/mnt/c/Windows/System32/OpenSSH"

    alias ssh="ssh.exe"
    alias scp="scp.exe"
    alias ssh-add="ssh-add.exe"

    # Agent forwarding wrapper
    function wssh() {
        ssh.exe -F /dev/null -A "$@"
    }

    # WSL-friendly SCP
    function wscp() {
        local win_paths=()
        for arg in "$@"; do 
            # Check if argument is a remote path (contains colon) or already Windows path
            if [[ "$arg" == *:* ]] || [[ "$arg" == /mnt/* ]]; then
                win_paths+=("$arg")
            # Check if argument is a local file that exists
            elif [[ -e "$arg" ]]; then
                win_paths+=("$(wslpath -w "$arg" | sed 's/\\/\\\\/g')")
            else
                win_paths+=("$arg")
            fi
        done
        scp.exe -F /dev/null "${win_paths[@]}"
    }
    
    echo "SSH: Using Windows native client"

fi 
